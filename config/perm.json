/*
cql grant [common params] --wait-tx-confirm -to-user 4119ef99... -to-dsn covenantsql://43602c17... -perm "$(<perm.json)"
*/

{
    "patterns": ["SHOW TABLES","\n\t\tcreate table if not exists s3 (\n\t\t\tid            integer      primary key,\n            bucket        text         not null,\n\t\t\tpath          text         not null,\n            size          integer,\n\t\t\tdata          blob\n\t\t);\n\t\tcreate index if not exists path_idx on s3(path);\n\t\tcreate unique index if not exists bucket_path_idx on s3(bucket, path);\n\t","\n\t\tcreate table if not exists users (\n\t\t\tid            integer      primary key,\n\t\t\tname          text         default null,\n\t\t\tcreated_at    timestamp    not null,\n\t\t\tauth_service  text         not null,\n\t\t\tauth_id       text         not null,\n\t\t\tblocked       boolean      not null default false,\n\t\t\tadmin         boolean      not null default false,\n\t\t\tavatar        text         not null default ''\n\t\t);\n\t\tcreate unique index if not exists name_idx on users(lower(name));\n\t\tcreate unique index if not exists auth_idx on users(auth_service, auth_id);\n\t","\n\t\tcreate table if not exists topics (\n\t\t\tid               integer      primary key,\n\t\t\tauthor_id        bigint       not null references users(id),\n\t\t\ttitle            text         not null,\n\t\t\tcreated_at       timestamp    not null,\n\t\t\tlast_comment_at  timestamp    not null,\n\t\t\tdeleted          boolean      not null default false,\n\t\t\tcomment_count    int          not null default 0\n\t\t);\n\t\tcreate index if not exists comment_idx on topics(last_comment_at);\n\t","\n\t\tcreate table if not exists comments (\n\t\t\tid          integer       primary key,\n\t\t\ttopic_id    bigint        not null references topics(id),\n\t\t\tauthor_id   bigint        not null references users(id),\n\t\t\tcontent     text          not null,\n\t\t\tcreated_at  timestamp     not null,\n\t\t\tdeleted     boolean       not null default false\n\t\t);\n\t\tcreate index if not exists topic_idx on comments(topic_id);\n\t\tcreate index if not exists create_idx on comments(created_at);\n\t","alter table topics add column request_hash text not null default '';\n\t","alter table comments add column request_hash text not null default '';\n\t","\n\t\t\tinsert into topics(author_id, title, created_at, last_comment_at)\n\t\t\tvalues(?, ?, ?, ?)\n\t\t","insert into comments(topic_id, author_id, content, created_at) values (?, ?, ?, ?)","insert into s3(bucket, path, size, data) values (?, ?, ?, ?)","delete from s3 where bucket = ? and path = ?","select data from s3 where bucket = ? and path = ?","update topics set request_hash=? where id=?","select id, author_id, title, created_at, last_comment_at, comment_count, request_hash from topics where deleted=false and id=?","select count(*) from topics where deleted=false","select id, author_id, title, created_at, last_comment_at, comment_count, request_hash from topics where deleted=false order by last_comment_at desc, id desc limit ? offset ?","update topics set title=? where id=?","update topics set deleted=true where id=?","insert into users(created_at, auth_service, auth_id) values(?, ?, ?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id=?","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where admin=true","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where name=?","\n\tselect \n\t\tid, \n\t\tcoalesce(name, '') as name, \n\t\tcreated_at,\n\t\tauth_service,\n\t\tauth_id,\n\t\tblocked,\n\t\tadmin, \n\t\tavatar \n\tfrom users\n where auth_service=? and auth_id=?","update users set name=? where id=?","update users set blocked=? where id=?","update users set admin=? where id=?","update users set avatar=? where id=?","update topics set last_comment_at=?, comment_count=comment_count+1 where id=?","update comments set request_hash=? where id=?","select id, topic_id, author_id, content, created_at, request_hash from comments where deleted=false and id=?","select count(*) from comments where deleted=false and topic_id=?","select id, topic_id, author_id, content, created_at, request_hash from comments where deleted=false and topic_id=? order by created_at, id limit ? offset ?","update comments set content=? where id=?","update comments set deleted=true where id=?","\n\t\tupdate topics set \n\t\t\tlast_comment_at=(select max(created_at) from comments where comments.topic_id=topics.id and comments.deleted=false),\n\t\t\tcomment_count=topics.comment_count-1\n\t\twhere topics.id=(select topic_id from comments where id = ?)\n\t\t"],
    "role": "Read,Write"
}
